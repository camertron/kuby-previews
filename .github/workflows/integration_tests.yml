name: Integration Tests
on:
  pull_request:
    branches:
      - '*'
  push:
    branches:
      - '*'
jobs:
  build:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        # NOTE: these need to be valid kindest/node image versions
        # k8s_version: ['1.21.2', '1.22.7', '1.23.5']
        k8s_version: ['1.23.5']
    steps:
      - name: Disable Swap
        run: |
          sudo swapoff -a
          sudo rm -f /swapfile

      - uses: actions/checkout@v2
        with:
          path: kuby-previews/

      - name: Clone kuby_test repo
        run: |
          git clone https://github.com/getkuby/kuby_test.git
          cp -r kuby-previews/ kuby_test/vendor/

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          working-directory: kuby_test/
          bundler-cache: true

      - name: Add bundler platform
        working-directory: kuby_test/
        run: |
          bundle config unset deployment
          bundle lock --add-platform $(ruby -rbundler -e 'puts Bundler.local_platform.to_s')

      - name: Add gems
        working-directory: kuby_test/
        run: |
          bundle add kuby-previews --path vendor/kuby-previews --skip-install
          bundle add kuby-prebundler --version '~> 0.1' --skip-install
          bundle add kuby-kind --version '~> 0.2' --skip-install
          bundle add activerecord-cockroachdb-adapter --version '~> 6.0' --skip-install

      - name: Install added gems
        working-directory: kuby_test/
        run: bundle install --jobs $(nproc) --retry 3

      - uses: actions/setup-node@v2
        with:
          node-version: '16'
          cache: yarn
          cache-dependency-path: kuby_test/yarn.lock
        env:
          CXXFLAGS: --std=c++17

      - uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Kind
        run: kuby-previews/scripts/install-kind.sh

      - name: Run Tests
        run: kuby-previews/scripts/integration.sh
        env:
          K8S_VERSION: ${{ matrix.k8s_version }}
          PREBUNDLER_ACCESS_KEY_ID: "${{ secrets.PREBUNDLER_ACCESS_KEY_ID }}"
          PREBUNDLER_SECRET_ACCESS_KEY: "${{ secrets.PREBUNDLER_SECRET_ACCESS_KEY }}"

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
